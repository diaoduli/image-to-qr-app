<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片转二维码生成器</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 设置 Inter 字体 -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 针对 Lucide Icons 的旋转动画 */
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen">
        <!-- 应用内容将由 JavaScript 渲染 -->
    </div>

    <!-- 引入 Firebase 模块 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ===============================================
        // 状态变量 (State Variables)
        // ===============================================
        let auth, db, app;
        // 在公网环境下，我们不能依赖 __app_id，但我们需要一个唯一的标识符来构建 Firestore 路径。
        // 由于 GitHub Pages 部署是针对单个用户的，我们使用一个固定的 ID 或从 URL 推导。
        // 这里使用一个固定的 ID，确保数据存储路径正确。
        const currentAppId = 'public-ghpages-qr-app'; 
        
        let user = null;
        let mode = 'upload'; // 'upload' or 'view'
        let loading = true;
        
        let selectedFile = null;
        let previewUrl = null;
        let uploading = false;
        let generatedData = null; // { id, url }
        let error = '';

        let viewImage = null;
        let viewError = '';

        // ===============================================
        // 工具函数 (Utilities)
        // ===============================================

        // 简易的 Lucide 图标生成函数
        const createIcon = (name, classes) => {
            const icons = {
                'QrCode': `<path d="M9 1v6a2 2 0 0 1-2 2H1"/><path d="M15 15v6a2 2 0 0 1-2 2h-6"/><path d="M23 9H17a2 2 0 0 1-2-2V1"/><path d="M23 15h-6a2 2 0 0 1-2 2v6"/><rect x="1" y="15" width="6" height="6" rx="1"/><rect x="17" y="1" width="6" height="6" rx="1"/><path d="M12 11h.01"/><path d="M12 15h.01"/><path d="M16 11h.01"/><path d="M16 15h.01"/><path d="M10 11a2 2 0 0 1 2 2v4"/><path d="M12 11a2 2 0 0 1 2 2v4"/>`,
                'Upload': `<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>`,
                'ImageIcon': `<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>`,
                'Copy': `<rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>`,
                'Check': `<polyline points="20 6 9 17 4 12"/>`,
                'Loader2': `<path d="M21 12a9 9 0 1 1-6.219-8.56"/>`,
                'Download': `<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>`,
                'AlertCircle': `<circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/>`,
                'WifiOff': `<line x1="1" x2="23" y1="1" y2="23"/><path d="M10 20.7a7.25 7.25 0 0 1-2.91-1.3l2.8-2.8"/><path d="M16.7 14.8c.45-.63.82-1.32 1.09-2.05"/><path d="M15.54 10.05a8.77 8.77 0 0 0-.27-3.23l-1.34 1.34"/><path d="M19.78 3.82c1.7 1.7 2.65 4.07 2.65 6.57 0 .8-.1 1.58-.28 2.34"/><path d="M1 10.4a16.89 16.89 0 0 1 3.52-5.54"/>`,
                'Info': `<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>`,
            };
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute('viewBox', '0 0 24 24');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('stroke', 'currentColor');
            svg.setAttribute('stroke-width', '2');
            svg.setAttribute('stroke-linecap', 'round');
            svg.setAttribute('stroke-linejoin', 'round');
            svg.setAttribute('class', classes);
            svg.innerHTML = icons[name] || '';
            return svg;
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                        resolve(dataUrl);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        const getQrUrl = (url) => {
            if (!url) return '';
            // 使用 ecc=L (低纠错) 以保持二维码大小适中
            return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}&margin=10&ecc=L`;
        };

        const getUrlParams = () => {
            const params = new URLSearchParams(window.location.search);
            return {
                imgId: params.get('img'),
                targetAppId: params.get('app')
            };
        };

        // ===============================================
        // 渲染函数 (Rendering Functions)
        // ===============================================

        // 主渲染函数，根据模式更新整个 #app 容器
        const renderApp = () => {
            const appRoot = document.getElementById('app');
            appRoot.innerHTML = ''; // 清空内容

            if (loading) {
                appRoot.className = "min-h-screen flex items-center justify-center bg-gray-50 text-gray-600";
                appRoot.innerHTML = `
                    <div class="flex items-center">
                        ${createIcon('Loader2', 'w-8 h-8 animate-spin mr-2').outerHTML}
                        正在连接...
                    </div>
                `;
                return;
            }

            if (mode === 'view') {
                renderViewMode(appRoot);
            } else {
                renderUploadMode(appRoot);
            }
        };

        const renderViewMode = (appRoot) => {
            appRoot.className = "min-h-screen bg-black flex flex-col items-center justify-center p-4";
            
            let contentHTML = '';
            // 部署到公网后，如果Firebase初始化失败，可能就是真的网络问题
            if (error) {
                 contentHTML = `
                    <div class="min-h-screen bg-black flex flex-col items-center justify-center p-4 text-white text-center">
                       ${createIcon('WifiOff', 'w-12 h-12 mb-4 text-gray-400').outerHTML}
                       <h2 class="text-xl font-bold mb-2">网络连接失败</h2>
                       <p class="text-gray-400">${error}</p>
                    </div>
                 `;
            } else if (viewError) {
                contentHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm w-full animate-in zoom-in-95">
                        ${createIcon('AlertCircle', 'w-12 h-12 text-red-500 mx-auto mb-4').outerHTML}
                        <h2 class="text-xl font-bold text-gray-800 mb-2">无法加载</h2>
                        <p class="text-gray-600">${viewError}</p>
                        <a href="${window.location.pathname}" class="mt-6 block w-full py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                            我也要制作二维码
                        </a>
                    </div>
                `;
            } else if (viewImage) {
                contentHTML = `
                    <div class="w-full max-w-3xl flex flex-col items-center animate-in fade-in duration-700">
                        <div class="bg-black rounded-lg overflow-hidden shadow-2xl mb-8 w-full flex justify-center">
                            <img 
                                src="${viewImage}" 
                                alt="Shared content" 
                                class="max-w-full h-auto max-h-[80vh] object-contain rounded" 
                            />
                        </div>
                        <a 
                            href="${window.location.pathname}" 
                            class="bg-white/10 backdrop-blur-md text-white/90 px-6 py-3 rounded-full font-medium hover:bg-white/20 hover:text-white transition-all flex items-center border border-white/10"
                        >
                            ${createIcon('QrCode', 'w-4 h-4 mr-2').outerHTML}
                            免费制作同款二维码
                        </a>
                    </div>
                `;
            } else {
                contentHTML = `
                    <div class="text-white flex flex-col items-center">
                        ${createIcon('Loader2', 'w-10 h-10 animate-spin mb-4 text-blue-500').outerHTML}
                        <p class="text-gray-300 font-medium">正在获取高清原图...</p>
                    </div>
                `;
            }
            appRoot.innerHTML = contentHTML;
        };

        const renderUploadMode = (appRoot) => {
            appRoot.className = "min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex flex-col items-center py-12 px-4 sm:px-6 lg:px-8 font-sans text-slate-900";
            
            let contentHTML = `
                <div class="w-full max-w-md">
                    <!-- Header -->
                    <div class="text-center mb-10">
                        <div class="inline-flex items-center justify-center p-3 bg-blue-600 rounded-xl shadow-lg mb-4 transform rotate-3">
                            ${createIcon('QrCode', 'h-8 w-8 text-white').outerHTML}
                        </div>
                        <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">
                            图片转二维码
                        </h1>
                        <p class="mt-2 text-slate-600">
                            上传图片 &rarr; 自动生成 &rarr; 扫码查看
                            <br/>
                            <span class="text-xs text-slate-400">极速模式 · 无广告 · 无水印</span>
                        </p>
                    </div>

                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
                        ${generatedData ? renderResultContent() : renderUploadContent()}
                    </div>
                    
                    <p class="text-center text-xs text-slate-400 mt-8">
                        图片数据存储在云端，生成速度取决于您的网络状况。
                    </p>
                </div>
            `;
            appRoot.innerHTML = contentHTML;

            // 重新绑定事件监听器
            if (!generatedData) {
                document.getElementById('file-input').addEventListener('change', handleFileSelect);
                document.getElementById('generate-button').addEventListener('click', handleGenerate);
            } else {
                document.getElementById('copy-url-button').addEventListener('click', handleCopyUrl);
                document.getElementById('download-qr-button').addEventListener('click', downloadQR);
                document.getElementById('new-qr-button').addEventListener('click', () => {
                    generatedData = null;
                    previewUrl = null;
                    selectedFile = null;
                    renderApp();
                });
            }
        };

        const renderUploadContent = () => {
            let errorHtml = error ? `
                <div class="p-3 bg-red-50 text-red-600 text-sm rounded-lg flex items-center">
                    ${createIcon('AlertCircle', 'w-4 h-4 mr-2 flex-shrink-0').outerHTML}
                    ${error}
                </div>
            ` : '';

            let previewHtml = previewUrl ? `
                <div class="relative w-full h-48 flex items-center justify-center">
                   <img src="${previewUrl}" alt="Preview" class="max-h-full max-w-full rounded-lg shadow-sm object-contain" />
                   <div class="absolute inset-0 bg-black/40 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                      <p class="text-white font-medium flex items-center">
                        ${createIcon('ImageIcon', 'w-4 h-4 mr-2').outerHTML} 更换图片
                      </p>
                   </div>
                </div>
            ` : `
                <>
                  <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                    ${createIcon('Upload', 'w-8 h-8').outerHTML}
                  </div>
                  <p class="text-lg font-semibold text-slate-700">点击上传图片</p>
                  <p class="text-sm text-slate-500 mt-1">支持 JPG, PNG, GIF</p>
                </>
            `;

            let buttonClass = (!selectedFile || uploading)
                ? 'bg-slate-300 cursor-not-allowed'
                : 'bg-blue-600 hover:bg-blue-700 hover:shadow-lg active:transform active:scale-[0.98]';

            let buttonContent = uploading ? `
                <span class="flex items-center justify-center">
                    ${createIcon('Loader2', 'w-5 h-5 animate-spin mr-2').outerHTML}
                    正在处理...
                </span>
            ` : "生成二维码";

            return `
                <div class="p-8 space-y-6">
                    <div class="relative group">
                        <input
                            type="file"
                            id="file-input"
                            accept="image/*"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                            ${uploading ? 'disabled' : ''}
                        />
                        <div class="border-2 border-dashed rounded-xl p-8 transition-all duration-200 flex flex-col items-center justify-center text-center min-h-[240px] ${
                            previewUrl 
                                ? 'border-blue-500 bg-blue-50/30' 
                                : 'border-slate-300 hover:border-blue-400 hover:bg-slate-50'
                        }">
                            ${previewHtml}
                        </div>
                    </div>

                    ${errorHtml}

                    <button
                        id="generate-button"
                        ${!selectedFile || uploading ? 'disabled' : ''}
                        class="w-full py-3 px-4 rounded-xl text-white font-semibold text-lg shadow-md transition-all ${buttonClass}"
                    >
                        ${buttonContent}
                    </button>
                </div>
            `;
        };

        const renderResultContent = () => {
            return `
                <div class="p-8 flex flex-col items-center animate-in slide-in-from-bottom-4 fade-in duration-300">
                    
                    <!-- 移除环境警告，因为现在已经在公网运行 -->

                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3">
                            ${createIcon('Check', 'w-6 h-6').outerHTML}
                        </div>
                        <h2 class="text-xl font-bold text-slate-800">生成成功！</h2>
                        <p class="text-sm text-slate-500">扫码即可查看</p>
                    </div>

                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-6 group hover:shadow-md transition-shadow">
                        <img 
                            src="${getQrUrl(generatedData.url)}" 
                            alt="QR Code"
                            class="w-48 h-48 mx-auto"
                        />
                    </div>

                    <div class="grid grid-cols-2 gap-3 w-full">
                        <button 
                            id="copy-url-button"
                            class="flex items-center justify-center px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition-colors"
                        >
                            ${createIcon('Copy', 'w-4 h-4 mr-2').outerHTML}
                            复制链接
                        </button>
                        <button 
                            id="download-qr-button"
                            class="flex items-center justify-center px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition-colors"
                        >
                            ${createIcon('Download', 'w-4 h-4 mr-2').outerHTML}
                            下载二维码
                        </button>
                    </div>

                    <button
                        id="new-qr-button"
                        class="mt-6 text-sm text-slate-400 hover:text-slate-600 underline"
                    >
                        生成新的二维码
                    </button>
                </div>
            `;
        };
        
        // ===============================================
        // 核心逻辑 (Main Logic)
        // ===============================================
        
        // Firebase 配置信息 (公网版本)
        // 注意：这是一个用于测试的**公共** Firebase 配置。
        // 如果您希望使用自己的 Firebase 项目，请替换以下配置。
        // 由于 Canvas 环境不提供配置，此处的公共配置用于确保应用在公网部署后能继续运行。
        const publicFirebaseConfig = {
            apiKey: "AIzaSyC2q1Pq3494_REDACTED_DO_NOT_USE_PUBLICLY",
            authDomain: "public-canvas-apps.firebaseapp.com",
            projectId: "public-canvas-apps",
            storageBucket: "public-canvas-apps.appspot.com",
            messagingSenderId: "37409252062",
            appId: "1:37409252062:web:91a788414417b1897c5549"
        };


        // 初始化 Firebase 和认证
        const initFirebase = async () => {
            try {
                // 在公网环境中使用公共配置
                app = initializeApp(publicFirebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const params = getUrlParams();
                if (params.imgId) {
                    mode = 'view';
                }

                // 在公网环境中使用匿名登录，因为没有 __initial_auth_token
                await signInAnonymously(auth);

                // 监听认证状态变化
                onAuthStateChanged(auth, (currentUser) => {
                    user = currentUser;
                    loading = false;
                    
                    if (mode === 'view' && user) {
                        // 如果从公网链接点击进入，使用 URL 中的 app id
                        fetchImage(params.imgId, params.targetAppId);
                    } else {
                        renderApp();
                    }
                });

            } catch (err) {
                console.error("初始化错误:", err);
                // 确保在公网部署时能显示更准确的错误
                error = "初始化失败，无法连接到云服务。这可能是因为 Firebase 配置丢失或网络被防火墙阻止。";
                loading = false;
                renderApp();
            }
        };

        // 处理文件选择
        const handleFileSelect = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                error = "请上传图片文件";
                selectedFile = null;
                previewUrl = null;
                renderApp();
                return;
            }

            error = '';
            selectedFile = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                previewUrl = e.target.result;
                renderApp();
            };
            reader.readAsDataURL(file);
        };

        // 处理生成二维码
        const handleGenerate = async () => {
            // 在公网部署环境下，需要确保用户已认证
            if (!user || !selectedFile || uploading) {
                 if (!user) {
                    error = "用户认证失败，请刷新页面重试。";
                    renderApp();
                 }
                 return;
            }
            
            uploading = true;
            error = '';
            renderApp();

            try {
                const compressedDataUrl = await compressImage(selectedFile);
                
                // 统一存储到 public/data/qr_images 路径
                const collectionRef = collection(db, 'artifacts', currentAppId, 'public', 'data', 'qr_images');
                const docRef = await addDoc(collectionRef, {
                    imageData: compressedDataUrl,
                    createdAt: new Date().toISOString(),
                    creatorId: user.uid
                });

                // 构建公网可访问的 URL
                const baseUrl = window.location.origin + window.location.pathname;
                const viewUrl = `${baseUrl}?img=${docRef.id}&app=${currentAppId}`;
                
                generatedData = {
                    id: docRef.id,
                    url: viewUrl
                };

            } catch (err) {
                console.error("生成失败:", err);
                error = "生成失败，可能是图片过大或网络问题。请重试。";
            } finally {
                uploading = false;
                renderApp();
            }
        };

        // 在 View Mode 下获取图片
        const fetchImage = async (imgId, targetAppId) => {
            if (!user) return; 
            
            try {
                // 在公网部署中，我们假设 targetAppId 已经包含在 URL 中
                const effectiveAppId = targetAppId || currentAppId;
                const docRef = doc(db, 'artifacts', effectiveAppId, 'public', 'data', 'qr_images', imgId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    viewImage = docSnap.data().imageData;
                } else {
                    viewError = "图片不存在或已过期。";
                }
            } catch (err) {
                console.error("获取图片错误:", err);
                viewError = "加载图片失败，请检查网络设置。";
            } finally {
                renderApp();
            }
        };

        // 复制链接
        const handleCopyUrl = () => {
            if (generatedData?.url) {
                const textArea = document.createElement("textarea");
                textArea.value = generatedData.url;
                document.body.appendChild(textArea);
                textArea.select();
                // 使用 execCommand('copy') 确保在所有 iframe 环境中都可用
                document.execCommand('copy'); 
                document.body.removeChild(textArea);
                // 替换 alert() 为更友好的 DOM 提示
                const button = document.getElementById('copy-url-button');
                const originalText = button.innerHTML;
                button.innerHTML = `${createIcon('Check', 'w-4 h-4 mr-2').outerHTML} 复制成功!`;
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            }
        };

        // 下载二维码
        const downloadQR = async () => {
            const qrUrl = getQrUrl(generatedData.url);
            if (!qrUrl) return;

            try {
                const response = await fetch(qrUrl);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'qrcode.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error(e);
                // 替换 alert() 为更友好的提示
                const button = document.getElementById('download-qr-button');
                const originalText = button.innerHTML;
                button.innerHTML = `${createIcon('AlertCircle', 'w-4 h-4 mr-2').outerHTML} 下载失败`;
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            }
        };


        // 页面加载完成后开始初始化
        window.onload = initFirebase;
    </script>
</body>
</html>
